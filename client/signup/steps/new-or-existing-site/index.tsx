import { useTranslate } from 'i18n-calypso';
import { useEffect } from 'react';
import { useDispatch } from 'react-redux';
import StepWrapper from 'calypso/signup/step-wrapper';
import { removeSiteSlugDependency } from 'calypso/state/signup/actions';
import { saveSignupStep, submitSignupStep } from 'calypso/state/signup/progress/actions';
import NewOrExistingSiteScreen from './new-or-existing-site';
import { ChoiceType } from './types';

interface Props {
	goToNextStep: () => void;
	submitSignupStep: ( { stepName, wasSkipped }: { stepName: string; wasSkipped: boolean } ) => void;
	goToStep: ( stepName: string ) => void;
	stepName: string;
}

export default function NewOrExistingSiteStep( props: Props ): React.ReactNode {
	const dispatch = useDispatch();
	const translate = useTranslate();

	const headerText = translate( 'Choose where you want us to build your site.' );
	const subHeaderText = '';

	useEffect( () => {
		dispatch( saveSignupStep( { stepName: props.stepName } ) );
	}, [ dispatch, props.stepName ] );

	const newOrExistingSiteSelected = ( value: ChoiceType ) => {
		dispatch(
			submitSignupStep(
				{ stepName: props.stepName },
				{
					newOrExistingSiteChoice: value,
					forceAutoGeneratedBlogName: true,
				}
			)
		);
		if ( 'existing-site' === value ) {
			props.goToNextStep();
		} else {
			dispatch( removeSiteSlugDependency() );
			dispatch( submitSignupStep( { stepName: 'difm-site-picker', wasSkipped: true } ) );
			props.goToStep( 'site-info-collection' );
		}
	};

	return (
		<StepWrapper
			headerText={ headerText }
			fallbackHeaderText={ headerText }
			subHeaderText={ subHeaderText }
			fallbackSubHeaderText={ subHeaderText }
			stepContent={ <NewOrExistingSiteScreen onSelect={ newOrExistingSiteSelected } /> }
			align={ 'left' }
			hideSkip
			{ ...props }
		/>
	);
}
