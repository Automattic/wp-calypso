# WordPress.com API HTTP Layer

## Summary

WordPress.com API requests require an initial translation from understanding what data pieces of Calypso might be wanting and the endpoints on WordPress.com which can provide that data.
Once that translation has been made the requests have to be sent out over an HTTP connection.
This middleware layer provides a foundation under the API data layer which can be used to pass around pure and stateless descriptions of those desired HTTP requests.
By removing the burden of directly issuing and responding to HTTP requests in the API layer and moving it here, we can more easily accommodate global and centralized policies on those requests, such as batching, dropping, and retrying on failure.

In contrast to a fully-generic HTTP layer this one understands that requests are being made directly to the WordPress.com API and allowances are made in the HTTP Request descriptions to acknowledge this and make working with it a smoother process; for example, authentication is automatically handled.

## Why?

The end-goal for this two-layer middleware approach is to make offline-use first-class in Calypso and to enable things like mobile data management and battery optimization.

Let's look at how this system works from a high-level perspective.

## Overview

<!-- the following diagram was generated in draw.io - it can be edited by pasting in the following code into it again -->
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="731px" version="1.1" content="&lt;mxfile userAgent=&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36&quot; version=&quot;6.0.2.7&quot; editor=&quot;www.draw.io&quot; type=&quot;device&quot;&gt;&lt;diagram name=&quot;Page-1&quot;&gt;7Vtdc5s4FP0t++Dp7kM6fNiAH2PHbjObzqZJOts+dWSQbTYYURBxsr9+r0B8SnZIAtiTdWbawOVKwL1HRzoXZaBPN4+fQhSsvxAHewNNcR4H+sVA09ShrsAvZnniFkUdpZZV6DrcVhhu3X9x5sitsevgqOJICfGoG1SNNvF9bNOKDYUh2VbdlsSr3jVAKywYbm3kida/XYeuU6s1Ugr7Z+yu1tmdtezKAtn3q5DEPr/fQNOXyU96eYOyvrh/tEYO2ZZM+mygT0NCaHq0eZxijwU3C1vabr7jav7cIfZpkwZG2uABeTF/dceNAkTtNX8++pTFBDsQIn5KQromK+Ijb1ZYJ3YcPmDWsQonSRCSM4VdIhvX5sdruvG4E3506ffS8Q/m8nHEznwaPn3nLZKT4loeNHYtoiik5yznYPCJjzPb3PU87vMPpvSJowzFlICpeIMrQgL+CEviU+6mavx8SjwSJhHQleQH7B5aYG+Spzpz4XcXc8DTEpE4tHk0NY5qFK4w9xqmJhbnUjOet0+YbDBEARz4MDtTPiqWrqeN8oGWnobYQ9R9qKIZ8UGxyrvKe78mLjxr4UKWywgeq4QcOCg9RGFK8CTHliZg6/LDht0E/l2TiN3vwcVbHA40w4MYTBz3AQ5X7PASLvoY4MMGPvznufeYNw2g6W9ZE3iGUisBs9u1S/FtgJKob4GsqvArMKomqAnJfT7e9dxSQsDYvFBMkyEDwNU07Q84pPixSUqBRyrptHg6twUHqQa3rcv8kxllKa5kcE+6dCFdNxjZLEtTsgngHX0qxBfei1ZDWg0ZD40kWshzVz6c2tAtIECfsCi5wMDn/MLGdZyEVWQ5rDDAykNRJOGZ/aP0mbFuXIyNkZH58TdW2sjx8Pkca5Icay2keNwrqXMi57SuVki94PgfGY8fiNTzId2ItocibZsNabsxJzfN5lAYsFeXf85+Xv91eydh1AhG0SXw6ZRTKDtuxKGQmIAdQmSQ52GPrEK02TEuy0Tw9iEq0O98PhmZipSqJRTTdDYXqKiFUT5UqqNc1cVhDk7iMG+DyVVx5s1yzWKQrJuzMBi/YpKmPQtIyZQiolgR5nhJu9kBmNNCMeeUFhaKpsg42Srv3awUdbVXECl7QHQ8ExMbjNNpDpNasl+Dm3RF/oaZKWkKb4+eSg4BQ0QkgQhHn6lUgDdUaop0v7tp7HfXakRb84eD9HlfC01ToFImTe59AAAQd/L/XoFSmlkXMXvuurKJsM+Okb9rOhb6+Xx3d51k7VeMDyeFzNm5MVN6k0K61qcWsl41gZoYGVgygZ5fs6R/SQTNFoLSdCJ9v+qq0NEdqyspbLqSV6rR7zT2DvVVtiypLHdGDZc7rSus7GlKPMDI9+fN7Ou3mVRlQY9MaMF0OGfTAPudzgxz5JwEV4+CSzf7FFxjKU5kKjy2bQyZaYaE/pSUdqxSqs2au6pLyKVp+YbjDKSUaYyrUDsmKaXJKUsCxSVyvbiyGDkOKJr/Wyhab4bi2VFhURU/KcjF0wb57IPsc1In2ql1JPNwalqEdcuzTa8w/RCxt4iimEk6yOqhNBZIrIlh9KaxRkafGitb1r1QZIHGWkBMBJHFoXJSWQdQWVLgdKWysu8eHU9Oh5plzLmizOc7Z8fK5JhrvuJas9lHVhxU21ZZzQp2llLDRPpQvNWeyt+ozl6jWkfpGwsdvbR+aZi1+4z3VyTr/pbVbkVSFUuSp+9+xypDZczYmQzNtnCc6k8yPm3GjJaEGbVOmPGlPFTnu0N/GVHFIvm3ExEdKxEZvRJRz4Xw3SukIyofvIyI8m3PZSI6Ch6q71+z9tNQzV1tmYXykSGqyNp2UrHsEAcOojsLYEIndJ184Q2CBNnQspdyBN8p+3vs/8G+JDiHqkVMgEIS+Pa19bXPWkQ2tF5Yi1hATNjW/not4gY7sY3D6FSC6K0EIcVLZyUIUYLV4FIkN8MGu3AWJZE6BwfNCh4lOwUa77HzPDeIduW141WQYVt4sRRoo16oBE8HYWtpN1sKJXudulgKGePqliJVsifAkiDFagMpz+4keSVSJiekdI8UXbJo7gwp4jfkdpAyPSGle6QYkumnK6Rk3/haR8rFCSndI8UadoYUOC3+cjTVUsXf5+qz/wA=&lt;/diagram&gt;&lt;/mxfile&gt;" onclick="(function(svg){var src=window.event.target||window.event.srcElement;while (src!=null&amp;&amp;src.nodeName.toLowerCase()!='a'){src=src.parentNode;}if(src==null){if(svg.wnd!=null&amp;&amp;!svg.wnd.closed){svg.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&amp;&amp;evt.source==svg.wnd){svg.wnd.postMessage(decodeURIComponent(svg.getAttribute('content')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);svg.wnd=window.open('https://www.draw.io/?client=1&amp;lightbox=1&amp;chrome=0&amp;edit=_blank');}}})(this);" viewBox="0 0 731 885" style="cursor:pointer;max-width:100%;max-height:885px;"><defs/><g transform="translate(0.5,0.5)"><path d="M 241 82 Q 241 82 354.63 82" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 359.88 82 L 352.88 85.5 L 354.63 82 L 352.88 78.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(273.5,65.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="45" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">dispatch</div></div></foreignObject><text x="23" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">dispatch</text></switch></g><rect x="81" y="2" width="160" height="160" rx="24" ry="24" fill="none" stroke="#97d077" stroke-width="3" pointer-events="none"/><g transform="translate(106.5,68.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="108" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 108px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">I'm a Post viewer<div>I need to like a post!</div></div></div></foreignObject><text x="54" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><g transform="translate(112.5,5.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="96" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(109, 150, 86); line-height: 1.2; vertical-align: top; width: 98px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">React Component</div></div></foreignObject><text x="48" y="12" fill="#6D9656" text-anchor="middle" font-size="12px" font-family="Helvetica">React Component</text></switch></g><path d="M 481 112 Q 481 177 321 177 Q 161 177 161 235.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 161 240.88 L 157.5 233.88 L 161 235.63 L 164.5 233.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 361 112 L 409 52 L 601 52 L 553 112 Z" fill="none" stroke="#ffb570" stroke-width="3" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(446.5,68.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="68" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 70px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">LIKE_POST<div>siteId, postId</div></div></div></foreignObject><text x="34" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 241 322 Q 241 322 354.63 322" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 359.88 322 L 352.88 325.5 L 354.63 322 L 352.88 318.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(273.5,305.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="45" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(151, 208, 119); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><font color="#000000">dispatch</font></div></div></foreignObject><text x="23" y="12" fill="#97D077" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 81 322 Q 26 322 26 502 Q 26 682 93.5 682 Q 161 682 161 715.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 161 720.88 L 157.5 713.88 L 161 715.63 L 164.5 713.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="81" y="242" width="160" height="160" rx="24" ry="24" fill="none" stroke="#7ea6e0" stroke-width="3" pointer-events="none"/><g transform="translate(93.5,301.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="134" height="40" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 136px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">I know how to like a post!<div>but I need to send an</div><div>HTTP request!</div></div></div></foreignObject><text x="67" y="26" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><g transform="translate(118.5,245.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(151, 208, 119); line-height: 1.2; vertical-align: top; width: 86px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><font color="#7ea6e0">API Middleware</font></div></div></foreignObject><text x="42" y="12" fill="#97D077" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 481 352 Q 481 417 321 417 Q 161 417 161 475.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 161 480.88 L 157.5 473.88 L 161 475.63 L 164.5 473.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 361 352 L 409 292 L 601 292 L 553 352 Z" fill="none" stroke="#ffb570" stroke-width="3" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(428.5,308.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="104" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 106px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">HTTP_REQUEST<div>/sites/posts/like/add</div></div></div></foreignObject><text x="52" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 241 522 Q 301 522 301 517 Q 301 512 354.63 512" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 359.88 512 L 352.88 515.5 L 354.63 512 L 352.88 508.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(279.5,468.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="43" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">HTTP<div>success</div></div></div></foreignObject><text x="22" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 241 602 Q 301 602 301 607 Q 301 612 354.63 612" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 359.88 612 L 352.88 615.5 L 354.63 612 L 352.88 608.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(284.5,628.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="33" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">HTTP<div>failure</div></div></div></foreignObject><text x="17" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="81" y="482" width="160" height="160" rx="24" ry="24" fill="none" stroke="#ea6b66" stroke-width="3" pointer-events="none"/><g transform="translate(100.5,534.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="120" height="54" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 122px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">I know how to manage<div>HTTP requests!</div><div><br /></div><div>Let's issue one!</div></div></div></foreignObject><text x="60" y="33" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><g transform="translate(112.5,485.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="96" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(151, 208, 119); line-height: 1.2; vertical-align: top; width: 98px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><font color="#ea6b66">HTTP Middleware</font></div></div></foreignObject><text x="48" y="12" fill="#97D077" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 601 512 Q 631 512 631 657 Q 631 802 247.37 802" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 242.12 802 L 249.12 798.5 L 247.37 802 L 249.12 805.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 361 542 L 409 482 L 601 482 L 553 542 Z" fill="none" stroke="#ffb570" stroke-width="3" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(446.5,498.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="68" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 70px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">LIKE_POST<div>siteId, postId</div></div></div></foreignObject><text x="34" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 481 642 Q 481 682 321 682 Q 161 682 161 715.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 161 720.88 L 157.5 713.88 L 161 715.63 L 164.5 713.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 361 642 L 409 582 L 601 582 L 553 642 Z" fill="none" stroke="#ffb570" stroke-width="3" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(443.5,598.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="74" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 76px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">ULIKE_POST<div>siteId, postId</div></div></div></foreignObject><text x="37" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 81 802 Q 1 802 1 442 Q 1 82 74.63 82" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 79.88 82 L 72.88 85.5 L 74.63 82 L 72.88 78.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="81" y="722" width="160" height="160" rx="24" ry="24" fill="none" stroke="#b266ff" stroke-width="3" pointer-events="none"/><g transform="translate(103.5,774.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="114" height="54" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 114px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><div>I know how to update</div><div>the app state!</div><div><br /></div><div>Post (un)liked!</div></div></div></foreignObject><text x="57" y="33" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><g transform="translate(134.5,725.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="52" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(151, 208, 119); line-height: 1.2; vertical-align: top; width: 52px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><font color="#b266ff">Reducers</font></div></div></foreignObject><text x="26" y="12" fill="#97D077" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><ellipse cx="686" cy="82" rx="40" ry="40" fill="#dae8fc" stroke="#6c8ebf" stroke-width="6" pointer-events="none"/><g transform="translate(675.5,65.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="19" height="31" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 204); line-height: 1.2; vertical-align: top; width: 19px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><font style="font-size: 28px">A</font></div></div></foreignObject><text x="10" y="22" fill="#0000CC" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><ellipse cx="686" cy="322" rx="40" ry="40" fill="#dae8fc" stroke="#6c8ebf" stroke-width="6" pointer-events="none"/><g transform="translate(675.5,305.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="19" height="31" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 204); line-height: 1.2; vertical-align: top; width: 19px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><font style="font-size: 28px">B</font></div></div></foreignObject><text x="10" y="22" fill="#0000CC" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><ellipse cx="686" cy="562" rx="40" ry="40" fill="#dae8fc" stroke="#6c8ebf" stroke-width="6" pointer-events="none"/><g transform="translate(674.5,545.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="21" height="31" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 204); line-height: 1.2; vertical-align: top; width: 21px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><font style="font-size: 28px">C</font></div></div></foreignObject><text x="11" y="22" fill="#0000CC" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><ellipse cx="686" cy="802" rx="40" ry="40" fill="#dae8fc" stroke="#6c8ebf" stroke-width="6" pointer-events="none"/><g transform="translate(674.5,785.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="21" height="31" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 204); line-height: 1.2; vertical-align: top; width: 21px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><font style="font-size: 28px">D</font></div></div></foreignObject><text x="11" y="22" fill="#0000CC" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></g></svg>

Wow, how confusing!
Well, this isn't promising to make everything easier, but it _is_ promising to make things worth while.

### Step A: Component needs data

A React component wants to indicate that a given post ought to be marked as liked.
It's API includes two functions for accomplishing this: `likePost( siteId, postId )` and `unlikePost( siteId, postId )`.
It knows nothing about how those two functions work, only that they are the names it uses to accomplish its goal.
It calls `likePost` after the user clicks on the like button.

### Step B: API middleware intercepts action

The WordPress.com API middleware understands what it means to like a post.
It knows that when we do so, the server needs to also be notified so that the like actually persists.
Further, it knows that it's possible that the server might reject the like, or some other trigger might cause the like to fail.

The middleware speaks with the WordPress.com servers through HTTP requests.
These requests have special properties: they can fail, we might want them to automatically retry upon failure, they can be batched, etc.
Therefore, instead of coding all of this logic into the API middleware itself the middleware will issue another declarative action describing the HTTP request and the meta information and policies about that request.
The new action carries along the information for the request such as the WordPress.com API path and associated query data, an action to dispatch if the request is a success, and an action to dispatch if the request fails.

Because this middleware is merely attempting to keep the server in sync with Calypso's updated state, it needs to pass the action along so that the reducers get the chance to update the app state and reflect the change.

### Step C: HTTP middleware runs actual HTTP request

The HTTP middleware understands what it means to run HTTP requests.
It may take some liberties in how it decides to actually execute the requests.
This liberty is what allows us to provide the global policies like retry behavior, offline behavior, and batching.

In whatever means it decides fitting, the middleware issues the HTTP request.
When either a response comes back in or the request fails, the middleware will dispatch a new follow-up action.
This action comes from the original HTTP Request action but it will be wrapped with meta information including the response data or error message.
That action gets reinjected into Redux and will presumably be handled by more middleware.

In this case, we have assumed that a successful response from the server means that the like when through.
This is a wrong assumption, but it is good enough for this discussion.
As seen in the diagram, the API middleware instructed the HTTP middleware to fire a `LIKE_POST` action if the HTTP request succeeds and an `UNLIKE_POST` action if it fails.
This `UNLIKE_POST` action will end up rolling back the first like, which in effect could not be completed because the server failed to update.


### Step D: Reducers see action and update app state

The actual `LIKE_POST` action (and possible the `UNLIKE_POST` as well) hit the reducers and the app state is updated.
This will trigger a re-render on the post component which started the chain and we come full circle.

## Implementation

If you would like to take advantage of this system you will want to use the provided helper methods and structure your code into three pieces: a function which generates the descriptive HTTP requests; a function which handles successful responses; and a function which handles failing responses.

Each of these functions will take the normal middleware arguments but the success and failure functions take an additional argument which is the response data or error respectively.

```js
// API Middleware, Post Like
import { LIKE_POST } from 'state/action-types';
import { local } from 'state/data-layer/utils';
import { fetch } from 'state/data-layer/wpcom-http/actions';
import { QUEUE_REQUEST } from 'state/data-layer/wpcom-http/constants';

/**
 * @see https://developer.wordpress.com/docs/api/1.1/post/sites/%24site/posts/%24post_ID/likes/new/ API description
 */
const likePost = ( { dispatch }, action, next ) => {
	// dispatch intent to issue HTTP request
	dispatch( fetch( {
		method: 'POST',
		path: '/sites/%s/posts/%d/likes/new',
		pathArgs: [ action.siteId, action.postId ],
		
		// we can reuse the original action because
		// we will use meta to indicate which part
		// of the process we are in
		onSuccess: action,
		onFailure: action,
		
		// indicate what should happen if we have
		// no network connection: queue to replay
		// when the network reconnects
		// (not implemented yet)
		whenOffline: QUEUE_REQUEST,
	} ) );
	
	// feed LIKE_POST action along to reducers
	// and skip additional middleware (the local part)
	next( local( action ) );
}

/**
 * Called on success from HTTP middleware with `data` parameter
 *
 * This is the place to map fromAPI to Calypso formats
 */
const verifyLike = ( { dispatch }, { siteId, postId }, next, data ) => {
	// this is a response to data coming in from the data layer,
	// so skip any data middleware processing with `local`
	dispatch( local( {
		type: data.i_like ? LIKE_POST : UNLIKE_POST,
		siteId,
		postId,
		likeCount: data.like_count,
	} ) );
}

/**
 * Called on failure from the HTTP middleware with `error` parameter
 */
const undoLike = ( { dispatch }, { siteId, postId }, next, error ) => {
	// skip data layer middleware with `local`
	dispatch( local( {
		type: UNLIKE_POST,
		siteId,
		postId,
	} ) );
}

export default {
	// watch for this action       -> initiate, onSuccess,  onFailure
	[ LIKE_POST ]: [ dispatchRequest( likePost, verifyLike, undoLike ) ]
};
```
