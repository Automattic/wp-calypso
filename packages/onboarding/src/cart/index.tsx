import config from '@automattic/calypso-config';
import { getUrlParts } from '@automattic/calypso-url';
import { NewSiteSuccessResponse, Site } from '@automattic/data-stores';
import { guessTimezone, getLanguage } from '@automattic/i18n-utils';
import debugFactory from 'debug';
import { getLocaleSlug } from 'i18n-calypso';
import { startsWith, isEmpty } from 'lodash';
import wpcomRequest from 'wpcom-proxy-request';
import { setupSiteAfterCreation, isTailoredSignupFlow } from '../';
import cartManagerClient from './create-cart-manager-client';
import type { MinimalRequestCartProduct } from '@automattic/shopping-cart';

const debug = debugFactory( 'calypso:signup:step-actions' );

interface GetNewSiteParams {
	flowToCheck: string;
	isPurchasingDomainItem: boolean;
	themeSlugWithRepo: string;
	siteUrl?: string;
	siteTitle: string;
	siteAccentColor: string;
	useThemeHeadstart: boolean;
	siteVisibility: Site.Visibility;
	username: string;
}

type NewSiteParams = {
	blog_title: string;
	public: Site.Visibility;
	blog_name: string;
	find_available_url: boolean;
	options: {
		designType: string;
		theme: string;
		use_theme_annotation: boolean;
		default_annotation_as_primary_fallback: boolean;
		site_segment: undefined;
		site_information: {
			title: string;
		};
		site_creation_flow: string;
		timezone_string?: string;
		wpcom_public_coming_soon: 0 | 1;
		site_accent_color?: string;
	};
	validate: boolean;
};

export const getNewSiteParams = ( {
	flowToCheck,
	isPurchasingDomainItem,
	themeSlugWithRepo,
	siteUrl,
	siteTitle,
	siteAccentColor,
	useThemeHeadstart = false,
	siteVisibility,
	username,
}: GetNewSiteParams ) => {
	const useAutoGeneratedBlogName = ! siteUrl;
	const blogName = useAutoGeneratedBlogName
		? siteTitle || username
		: siteUrl.replace( '.wordpress.com', '' );

	// We will use the default annotation instead of theme annotation as fallback,
	// when segment and vertical values are not sent. Check pbAok1-p2#comment-834.
	const newSiteParams: NewSiteParams = {
		blog_name: blogName,
		find_available_url: useAutoGeneratedBlogName ? true : !! isPurchasingDomainItem,
		blog_title: siteTitle,
		public: siteVisibility,
		options: {
			designType: '',
			theme: themeSlugWithRepo,
			use_theme_annotation: useThemeHeadstart,
			default_annotation_as_primary_fallback: true,
			site_segment: undefined,
			site_information: {
				title: siteTitle,
			},
			site_creation_flow: flowToCheck,
			timezone_string: guessTimezone(),
			wpcom_public_coming_soon: siteVisibility === 0 ? 1 : 0,
			...( siteAccentColor && { site_accent_color: siteAccentColor } ),
		},
		validate: false,
	};

	return newSiteParams;
};

export const createSiteWithCart = async (
	flowName: string,
	userIsLoggedIn: boolean,
	isPurchasingDomainItem: boolean,
	themeSlugWithRepo: string,
	siteVisibility: Site.Visibility,
	siteTitle: string,
	siteAccentColor: string,
	useThemeHeadstart: boolean,
	username: string,
	domainItem?: MinimalRequestCartProduct
) => {
	const siteUrl = domainItem?.meta;
	const isFreeThemePreselected = startsWith( themeSlugWithRepo, 'pub' );

	const newSiteParams = getNewSiteParams( {
		flowToCheck: flowName,
		isPurchasingDomainItem,
		themeSlugWithRepo,
		siteUrl,
		siteTitle,
		siteAccentColor,
		useThemeHeadstart,
		siteVisibility,
		username,
	} );

	// if ( isEmpty( bearerToken ) && 'onboarding-registrationless' === flowToCheck ) {
	// 	saveToLocalStorageAndProceed( state, domainItem, themeItem, newSiteParams, callback );
	// 	return;
	// }

	const locale = getLocaleSlug();
	const siteCreationResponse: NewSiteSuccessResponse = await wpcomRequest( {
		path: '/sites/new',
		apiVersion: '1.1',
		method: 'POST',
		body: {
			...newSiteParams,
			locale,
			lang_id: getLanguage( locale as string )?.value,
			client_id: config( 'wpcom_signup_id' ),
			client_secret: config( 'wpcom_signup_key' ),
		},
	} );

	if ( ! siteCreationResponse.success ) {
		// TODO ebuccelli: Manage siteCreationResponse.errors
		return;
	}

	const parsedBlogURL = getUrlParts( siteCreationResponse?.blog_details.url );
	const siteSlug = parsedBlogURL.hostname;
	const siteId = siteCreationResponse?.blog_details.blogid;
	const providedDependencies = {
		siteId,
		siteSlug,
		domainItem,
	};

	if ( isTailoredSignupFlow( flowName ) ) {
		await setupSiteAfterCreation( { siteId, flowName } );
	}

	await processItemCart(
		siteSlug,
		isFreeThemePreselected,
		themeSlugWithRepo,
		flowName,
		userIsLoggedIn,
		domainItem
	);

	return providedDependencies;
};

function prepareItemForAddingToCart( item: MinimalRequestCartProduct, lastKnownFlow?: string ) {
	return {
		...item,
		extra: {
			...item.extra,
			context: 'signup',
			...( lastKnownFlow && { signup_flow: lastKnownFlow } ),
		},
	};
}

export async function addPlanToCart(
	siteSlug: string,
	flowName: string,
	userIsLoggedIn: boolean,
	themeSlugWithRepo: string,
	cartItem: MinimalRequestCartProduct
) {
	if ( isEmpty( cartItem ) ) {
		// the user selected the free plan
		return;
	}

	const isFreeThemePreselected = startsWith( themeSlugWithRepo, 'pub' );

	await processItemCart(
		siteSlug,
		isFreeThemePreselected,
		themeSlugWithRepo,
		flowName,
		userIsLoggedIn,
		cartItem
	);
}

const addToCartAndProceed = async (
	newCartItem: MinimalRequestCartProduct,
	siteSlug: string,
	flowName: string
) => {
	const cartItem = prepareItemForAddingToCart( newCartItem, flowName );

	if ( cartItem ) {
		debug( 'adding products to cart', cartItem );
		const cartKey = await cartManagerClient.getCartKeyForSiteSlug( siteSlug );

		try {
			const updatedCart = await cartManagerClient
				.forCartKey( cartKey )
				.actions.addProductsToCart( [ cartItem ] );

			debug( 'product add request complete', updatedCart );
		} catch ( error ) {
			debug( 'product add request had an error', error );
			//TODO Manage error
			// reduxStore.dispatch( errorNotice( error.message ) );
		}
	} else {
		debug( 'no cart items to add' );
	}
};

export async function setThemeOnSite( siteSlug: string, themeSlugWithRepo: string ) {
	if ( isEmpty( themeSlugWithRepo ) ) {
		return;
	}

	const theme = themeSlugWithRepo.split( '/' )[ 1 ];

	try {
		await wpcomRequest( {
			path: `/sites/${ siteSlug }/themes/mine`,
			method: 'POST',
			apiVersion: '1.1',
			body: {
				theme,
			},
		} );
	} catch ( error ) {
		//TODO: Manage error
	}
}

async function processItemCart(
	siteSlug: string,
	isFreeThemePreselected: boolean,
	themeSlugWithRepo: string,
	lastKnownFlow: string,
	userIsLoggedIn: boolean,
	newCartItem?: MinimalRequestCartProduct
) {
	if ( ! userIsLoggedIn && isFreeThemePreselected ) {
		await setThemeOnSite( siteSlug, themeSlugWithRepo );
		newCartItem && ( await addToCartAndProceed( newCartItem, siteSlug, lastKnownFlow ) );
	} else if ( userIsLoggedIn && isFreeThemePreselected ) {
		await setThemeOnSite( siteSlug, themeSlugWithRepo );
		newCartItem && ( await addToCartAndProceed( newCartItem, siteSlug, lastKnownFlow ) );
	} else {
		newCartItem && ( await addToCartAndProceed( newCartItem, siteSlug, lastKnownFlow ) );
	}
}
