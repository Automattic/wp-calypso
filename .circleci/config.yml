references:
  shared-environment: &shared-environment
    CIRCLE_ARTIFACTS: /tmp/artifacts
    CIRCLE_TEST_REPORTS: /tmp/test_results

  docker-image: &docker-image
    - image: circleci/node:10.10.0-browsers

  setup-results-and-artifacts: &setup-results-and-artifacts
    name: Create Directories for Results and Artifacts
    command: |
      mkdir -p                             \
        "~/jest-cache"                     \
        "$CIRCLE_ARTIFACTS/translate"      \
        "$CIRCLE_TEST_REPORTS/client"      \
        "$CIRCLE_TEST_REPORTS/eslint"      \
        "$CIRCLE_TEST_REPORTS/integration" \
        "$CIRCLE_TEST_REPORTS/server"

  restore-jest-cache: &restore-jest-cache
    name: Restore Jest cache
    # @TODO drop dev
    keys:
      - v1dev-jest-{{ .Environment.CIRCLE_NODE_INDEX }}/{{ .Environment.CIRCLE_NODE_TOTAL }}-{{ .Branch }}-{{ .Revision }}
      - v1dev-jest-{{ .Environment.CIRCLE_NODE_INDEX }}/{{ .Environment.CIRCLE_NODE_TOTAL }}-{{ .Branch }}
      - v1dev-jest-{{ .Environment.CIRCLE_NODE_INDEX }}/{{ .Environment.CIRCLE_NODE_TOTAL }}-master
      - v1dev-jest-{{ .Environment.CIRCLE_NODE_INDEX }}/{{ .Environment.CIRCLE_NODE_TOTAL }}
  save-jest-cache: &save-jest-cache
    name: Save Jest cache
    # @TODO drop dev
    key: v1dev-jest-{{ .Environment.CIRCLE_NODE_INDEX }}/{{ .Environment.CIRCLE_NODE_TOTAL }}-{{ .Branch }}-{{ .Revision }}
    paths:
      - ~/jest-cache

  restore-git-cache: &restore-git-cache
    name: Restore git cache
    # @TODO drop dev
    keys:
      - v2dev-git-{{ .Branch }}-{{ .Revision }}
      - v2dev-git-{{ .Branch }}
      - v2dev-git-master
      - v2dev-git
  update-git-master: &update-git-master
    name: Update master branch
    command: git fetch --force origin master
  save-git-cache: &save-git-cache
    name: Save git cache
    # @TODO drop dev
    key: v2dev-git-{{ .Branch }}-{{ .Revision }}
    paths:
      - ".git"

  restore-npm-cache: &restore-npm-cache
    name: "Restore npm cache"
    keys:
       - v1-npmcache-{{ checksum ".nvmrc" }}-{{ checksum "npm-shrinkwrap.json" }}
       - v1-npmcache-{{ checksum ".nvmrc" }}
  save-npm-cache: &save-npm-cache
    name: "Save npm cache"
    key: v1-npmcache-{{ checksum ".nvmrc" }}-{{ checksum "npm-shrinkwrap.json" }}
    paths:
      - ~/.npm

  defaults: &defaults
    working_directory: ~/wp-calypso
    docker: *docker-image
    environment: *shared-environment

version: 2
jobs:
  build:
    <<: *defaults
    parallelism: 6

    steps:
      ###############
      # Basic Setup #
      # #############
      # repo
      - restore_cache: *restore-git-cache
      - checkout
      - run: *update-git-master
      - save_cache: *save-git-cache

      # npm dependencies
      - restore_cache: *restore-npm-cache
      - run: npm ci
      - save_cache: *save-npm-cache

      # folders to collect results
      - run: *setup-results-and-artifacts
      ###################
      # End Basic Setup #
      ###################

      - run:
          name: Build calypso-strings.pot
          command: |
            if [ "$CIRCLE_NODE_INDEX" == "0" ]; then
              npm run translate
              mv calypso-strings.pot "$CIRCLE_ARTIFACTS/translate"
            fi

      - run:
          name: Build New Strings .pot
          command: |
            if [ "$CIRCLE_NODE_INDEX" == "0" ]; then
              git clone https://github.com/Automattic/gp-localci-client.git
              bash gp-localci-client/generate-new-strings-pot.sh "$CIRCLE_BRANCH" "$CIRCLE_SHA1" "$CIRCLE_ARTIFACTS/translate"
              rm -rf gp-localci-client
            fi

      - restore_cache: *restore-jest-cache

      - run:
          name: Run Integration Tests

          #### @TODO REMOVE - FOR DEVELOPMENT ONLY ####
          environment:
            RUN_ARGS: "--nightly"
          #############################################

          command: |
            if [[ "$RUN_ARGS" != "--nightly" ]]; then
              echo "Regular build: skipping tests."
              exit 0
            fi

            JEST_JUNIT_OUTPUT="$CIRCLE_TEST_REPORTS/integration/test-results-integration.xml" npx --no-install \
              jest                                         \
                --ci                                       \
                --maxWorkers=2                             \
                --reporters=default                        \
                --reporters=jest-junit                     \
                --config=test/integration/jest.config.js   \
                $( circleci tests glob "bin/**/integration/*.js" "client/**/integration/*.js" "server/**/integration/*.js" | circleci tests split )

      - run:
          name: Lint Config Keys
          command: npm run lint:config-defaults

      - run:
          name: Lint Client and Server
          when: always
          command: |
            # We'll use failure code to do some additional processing and report failure manually
            set +o errexit

            # Run the lint
            npx --no-install eslint-eslines                           \
              $(                                                      \
                git diff --name-only --diff-filter=d origin/master... \
                | grep -E '^(client|server)'                          \
                | grep -E '\.jsx?$'                                   \
                | circleci tests split                                \
              )                                                       \
              -- --format junit                                       \
              > ~/eslint-results.xml

            # Ensure we don't upload empty reports.
            # Eslint would not produce a malformed empty xml using the --format and -o options.
            # However, with eslint-eslines and the redirected > output, we may get an empty file.
            # We only put the file into the reports directory if the status code informs us that
            # lint issues have been encountered.
            ESLINT_RESULT="$?"
            if [ "$ESLINT_RESULT" -ne 0 ]; then
              mv ~/eslint-results.xml "$CIRCLE_TEST_REPORTS/eslint"
              exit "$ESLINT_RESULT"
            fi

      - run:
          name: Run Client Tests
          when: always
          command: |
            JEST_JUNIT_OUTPUT="$CIRCLE_TEST_REPORTS/client/test-results-client.xml" npx --no-install \
              jest                                    \
                --ci                                  \
                --maxWorkers=2                        \
                --reporters=default                   \
                --reporters=jest-junit                \
                --config=test/client/jest.config.js   \
                $( [ "$CIRCLE_BRANCH" != "master" ] && echo "--changedSince='master'" ) \
                $( circleci tests glob "client/**/test/*.js" "client/**/test/*.jsx" | circleci tests split )

      - run:
          name: Run Server Tests
          when: always
          command: |
            JEST_JUNIT_OUTPUT="$CIRCLE_TEST_REPORTS/server/test-results-client.xml" npx --no-install \
              jest                                    \
                --ci                                  \
                --maxWorkers=2                        \
                --reporters=default                   \
                --reporters=jest-junit                \
                --config=test/server/jest.config.js   \
                $( [ "$CIRCLE_BRANCH" != "master" ] && echo "--changedSince='master'" ) \
                $( circleci tests glob "server/**/test/*.js" "server/**/test/*.jsx" | circleci tests split )

      - save_cache: *save-jest-cache

      - store_test_results:
          path: /tmp/test_results
      - store_artifacts:
          path: /tmp/test_results
      - store_artifacts:
          path: /tmp/artifacts

# We need to work around this bit because
# the notification system in 2.0 is a bit flakey
# and is not yet working as expected.
notify:
  webhooks:
    - url: https://translate.wordpress.com/api/localci/-relay-new-strings-to-gh
