references:
  #
  # Environment
  #
  shared-environment: &shared-environment
    CIRCLE_ARTIFACTS: /tmp/artifacts
    CIRCLE_TEST_REPORTS: /tmp/test_results

  #
  # Image
  #
  docker-image: &docker-image
    - image: circleci/node:10.10.0

  #
  # Cache management
  #
  restore-git-cache: &restore-git-cache
    name: Restore git cache
    keys:
      - v2-git-{{ .Branch }}-{{ .Revision }}
      - v2-git-{{ .Branch }}
      - v2-git
  save-git-cache: &save-git-cache
    name: Save git cache
    key: v2-git-{{ .Branch }}-{{ .Revision }}
    paths:
      - ".git"

  restore-npm-cache: &restore-npm-cache
    name: "Restore npm cache"
    keys:
       - v1-npmcache-{{ checksum ".nvmrc" }}-{{ checksum "npm-shrinkwrap.json" }}
       - v1-npmcache-{{ checksum ".nvmrc" }}
  save-npm-cache: &save-npm-cache
    name: "Save npm cache"
    key: v1-npmcache-{{ checksum ".nvmrc" }}-{{ checksum "npm-shrinkwrap.json" }}
    paths:
      - ~/.npm

  #
  # Artifact prep
  #
  setup-results-and-artifacts: &setup-results-and-artifacts
    name: Create Directories for Results and Artifacts
    command: mkdir -p                  \
      $CIRCLE_ARTIFACTS                \
      $CIRCLE_TEST_REPORTS/client      \
      $CIRCLE_TEST_REPORTS/server


version: 2
jobs:
  #
  # Shared setup required for all jobs
  #
  setup:
    docker: *docker-image
    working_directory: ~/wp-calypso
    steps:
      - restore_cache: *restore-git-cache
      - checkout
      # Update origin/master so we can diff against it later
      - run:
          name: Update master branch
          command: git fetch --force origin master
      - save_cache: *save-git-cache

      - restore_cache: *restore-npm-cache
      - run: npm ci
      - save_cache: *save-npm-cache
      - persist_to_workspace:
          root: .
          paths: .

  #
  # Build translations
  #
  translate:
    docker: *docker-image
    working_directory: ~/wp-calypso
    environment: *shared-environment

    steps:
      - attach_workspace:
          at: .

      - run: *setup-results-and-artifacts

      - run:
          name: Build calypso-strings.pot
          command: |
            npm run translate; mkdir -p $CIRCLE_ARTIFACTS/translate
            mv calypso-strings.pot $CIRCLE_ARTIFACTS/translate

      - run:
          name: Build New Strings .pot
          command: |
            git clone https://github.com/Automattic/gp-localci-client.git
            bash gp-localci-client/generate-new-strings-pot.sh $CIRCLE_BRANCH $CIRCLE_SHA1 $CIRCLE_ARTIFACTS/translate
            rm -rf gp-localci-client
      - store_artifacts:
          path: /tmp/artifacts

  #
  # Test Calypso
  #
  test-calypso:
    parallelism: 6
    docker: *docker-image
    working_directory: ~/wp-calypso
    environment: *shared-environment

    steps:
      - attach_workspace:
          at: .

      - run: *setup-results-and-artifacts

      - run:
          name: Lint Config Keys
          command: npm run lint:config-defaults

      - run:
          name: Lint Client and Server
          command: |
            ./node_modules/.bin/eslint-eslines $(git diff --name-only --diff-filter=d origin/master... | grep -E '^(client|server)' | grep -E '\.jsx?$' | circleci tests split)

      - run:
          name: Run Client Tests
          command: |
            JEST_JUNIT_OUTPUT="$CIRCLE_TEST_REPORTS/client/test-results-client.xml" npx --no-install \
              jest                                    \
                --ci                                  \
                --reporters=default                   \
                --reporters=jest-junit                \
                --config=test/client/jest.config.json \
                --maxWorkers=2                        \
                $(circleci tests glob "client/**/test/*.js" "client/**/test/*.jsx" | circleci tests split --split-by=timings)

      - run:
          name: Run Server Tests
          command: |
            JEST_JUNIT_OUTPUT="$CIRCLE_TEST_REPORTS/server/test-results-client.xml" npx --no-install \
              jest                                    \
                --ci                                  \
                --reporters=default                   \
                --reporters=jest-junit                \
                --config=test/server/jest.config.json \
                --maxWorkers=2                        \
                $(circleci tests glob "server/**/test/*.js" "server/**/test/*.jsx" | circleci tests split --split-by=timings)

      - store_test_results:
          path: /tmp/test_results
      - store_artifacts:
          path: /tmp/test_results

# We need to work around this bit because
# the notification system in 2.0 is a bit flakey
# and is not yet working as expected.
notify:
  webhooks:
    - url: https://translate.wordpress.com/api/localci/-relay-new-strings-to-gh

workflows:
  version: 2
  all-the-things:
    jobs:
      - setup
      - translate:
          requires:
            - setup
      - test-calypso:
          requires:
            - setup

