# frozen_string_literal: true

require 'dotenv'
require 'json'

fastlane_version '2.0'

default_platform :mac

PROJECT_ROOT_FOLDER = File.dirname(File.expand_path(__dir__))

ENV_FILE_NAME = 'wordpress-desktop.env'
USER_ENV_FILE_PATH = File.join(Dir.home, '.a8c-apps', ENV_FILE_NAME)

# TODO: This is duplicated with `after_sign_hook.js`. It would be nice to have a single source of truth.
TEAM_ID = '99KV9Z6BKV'

CODE_SIGNING_STORAGE_OPTIONS = {
  storage_mode: 's3',
  s3_bucket: 'a8c-fastlane-match',
  s3_region: 'us-east-2'
}.freeze

# Required for sync_code_signing to authenticate with S3.
CODE_SIGNING_ENV_VARS = %w[
  MATCH_S3_ACCESS_KEY
  MATCH_S3_SECRET_ACCESS_KEY
  MATCH_PASSWORD
].freeze

import 'lib/helpers.rb'

before_all do
  # This is necessary for 'match' to work correctly in CI. When running
  # locally, it has no effect so it's safe to run it before all lanes.
  setup_ci

  Dotenv.load(USER_ENV_FILE_PATH)
end

platform :mac do
  desc 'Download and configure code signing certificates and provisioning profiles .'
  lane :configure_code_signing do |readonly: true|
    require_env_vars!(*CODE_SIGNING_ENV_VARS)

	prompt_user_for_app_store_connect_credentials unless readonly

    sync_code_signing(
      type: 'developer_id',
      platform: 'macos',
      team_id: TEAM_ID,
      app_identifier: [], # empty because we only care about the certificate at the moment
      readonly: readonly,
      **CODE_SIGNING_STORAGE_OPTIONS
    )
  end
end
